{% extends "base.html" %}

{% block title %}Place Order - K-Logi{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-lg-9 col-md-11">
      <div class="card shadow-lg border-0 mb-4">
        <div class="card-header bg-primary text-white rounded-top">
          <h3 class="mb-0"><i class="fe-package me-2"></i>Place Your Order</h3>
          <p class="mb-0 small">Fill in the details below to place your delivery order</p>
        </div>
        <div class="card-body p-4">
          <form id="placeOrderForm" method="POST" enctype="multipart/form-data">
            <!-- Step 1: Customer Information -->
            <div class="mb-4">
              <div class="d-flex align-items-center mb-2">
                <span class="badge bg-primary me-2">1</span>
                <h5 class="mb-0 text-primary">Customer Information</h5>
              </div>
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="customer_name" class="form-label">Full Name *</label>
                  <input type="text" class="form-control" id="customer_name" name="customer_name" required>
                </div>
                <div class="col-md-6">
                  <label for="customer_email" class="form-label">Email Address *</label>
                  <input type="email" class="form-control" id="customer_email" name="customer_email" required>
                </div>
                <div class="col-md-6">
                  <label for="customer_phone" class="form-label">Phone Number *</label>
                  <input type="tel" class="form-control" id="customer_phone" name="customer_phone" required placeholder="Enter mobile number" maxlength="10" pattern="[6-9][0-9]{9}">
                  <div id="phoneError" class="text-danger mt-1" style="display:none;"></div>
                </div>
              </div>
            </div>

            <!-- Step 2: Pickup Address -->
            <div class="mb-4">
              <div class="d-flex align-items-center mb-2">
                <span class="badge bg-primary me-2">2</span>
                <h5 class="mb-0 text-primary">Pickup Address</h5>
              </div>
              <div class="row g-3">
                <div class="col-12">
                  <label for="pickup_address_line" class="form-label">Address Line *</label>
                  <textarea class="form-control" id="pickup_address_line" name="pickup_address_line" rows="2" required></textarea>
                </div>
                <div class="col-md-4">
                  <label for="pickup_pincode" class="form-label">Pincode *</label>
                  <input type="text" class="form-control" id="pickup_pincode" name="pickup_pincode" maxlength="6" required>
                  <div class="form-text">Enter 6-digit pincode</div>
                </div>
                <div class="col-md-4">
                  <label for="pickup_district" class="form-label">District *</label>
                  <input type="text" class="form-control" id="pickup_district" name="pickup_district" required readonly>
                </div>
                <div class="col-md-4">
                  <label for="pickup_state" class="form-label">State *</label>
                  <input type="text" class="form-control" id="pickup_state" name="pickup_state" required readonly>
                </div>
              </div>
            </div>

            <!-- Step 3: Delivery Address -->
            <div class="mb-4">
              <div class="d-flex align-items-center mb-2">
                <span class="badge bg-primary me-2">3</span>
                <h5 class="mb-0 text-primary">Delivery Address</h5>
              </div>
              <div class="row g-3">
                <div class="col-12">
                  <label for="delivery_address_line" class="form-label">Address Line *</label>
                  <textarea class="form-control" id="delivery_address_line" name="delivery_address_line" rows="2" required></textarea>
                </div>
                <div class="col-md-4">
                  <label for="delivery_pincode" class="form-label">Pincode *</label>
                  <input type="text" class="form-control" id="delivery_pincode" name="delivery_pincode" maxlength="6" required>
                  <div class="form-text">Enter 6-digit pincode</div>
                </div>
                <div class="col-md-4">
                  <label for="delivery_district" class="form-label">District *</label>
                  <input type="text" class="form-control" id="delivery_district" name="delivery_district" required readonly>
                </div>
                <div class="col-md-4">
                  <label for="delivery_state" class="form-label">State *</label>
                  <input type="text" class="form-control" id="delivery_state" name="delivery_state" required readonly>
                </div>
              </div>
            </div>

            <!-- Step 4: Package Details -->
            <div class="mb-4">
              <div class="d-flex align-items-center mb-2">
                <span class="badge bg-primary me-2">4</span>
                <h5 class="mb-0 text-primary">Package Details</h5>
              </div>
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="package_type" class="form-label">Package Type *</label>
                  <select class="form-control" id="package_type" name="package_type" required>
                    <option value="">Select Package Type</option>
                    <option value="electronics">Electronics</option>
                    <option value="clothing">Clothing</option>
                    <option value="home">Home & Garden</option>
                    <option value="books">Books & Documents</option>
                    <option value="food">Food & Beverages</option>
                    <option value="fragile">Fragile Items</option>
                    <option value="other">Other</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label for="zone_id" class="form-label">Delivery Zone *</label>
                  <select class="form-control" id="zone_id" name="zone_id" required>
                    <option value="">Select Zone</option>
                    {% for zone in zones %}
                    <option value="{{ zone.id }}" data-rate="{{ zone.base_rate }}" data-days="{{ zone.delivery_days }}">
                      {{ zone.name }} - â‚¹{{ zone.base_rate }}/kg ({{ zone.delivery_days }} days)
                    </option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-3">
                  <label for="weight" class="form-label">Weight (kg) *</label>
                  <input type="number" class="form-control" id="weight" name="weight" step="0.1" min="0.1" required>
                </div>
                <div class="col-md-3">
                  <label for="length" class="form-label">Length (cm) *</label>
                  <input type="number" class="form-control" id="length" name="length" step="0.1" min="1" required>
                </div>
                <div class="col-md-3">
                  <label for="width" class="form-label">Width (cm) *</label>
                  <input type="number" class="form-control" id="width" name="width" step="0.1" min="1" required>
                </div>
                <div class="col-md-3">
                  <label for="height" class="form-label">Height (cm) *</label>
                  <input type="number" class="form-control" id="height" name="height" step="0.1" min="1" required>
                </div>
                <div class="col-md-6">
                  <label for="quantity" class="form-label">Quantity</label>
                  <input type="number" class="form-control" id="quantity" name="quantity" value="1" min="1" required>
                </div>
                <div class="col-md-6">
                  <label for="package_description" class="form-label">Package Description</label>
                  <textarea class="form-control" id="package_description" name="package_description" rows="2" placeholder="Describe your package contents..."></textarea>
                </div>
              </div>
            </div>

            <!-- Step 5: Recipient Information -->
            <div class="mb-4">
              <div class="d-flex align-items-center mb-2">
                <span class="badge bg-primary me-2">5</span>
                <h5 class="mb-0 text-primary">Recipient Information</h5>
              </div>
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="recipient_name" class="form-label">Recipient Name *</label>
                  <input type="text" class="form-control" id="recipient_name" name="recipient_name" required>
                </div>
                <div class="col-md-6">
                  <label for="recipient_phone" class="form-label">Recipient Phone *</label>
                  <input type="tel" class="form-control" id="recipient_phone" name="recipient_phone" required>
                </div>
              </div>
            </div>

            <!-- Step 6: Payment Information -->
            <div class="mb-4">
              <div class="d-flex align-items-center mb-2">
                <span class="badge bg-primary me-2">6</span>
                <h5 class="mb-0 text-primary">Payment Information</h5>
              </div>
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="payment_mode" class="form-label">Payment Mode *</label>
                  <select class="form-control" id="payment_mode" name="payment_mode" required>
                    <option value="">Select Payment Mode</option>
                    <option value="cod">Cash on Delivery (COD)</option>
                    <option value="prepaid">Prepaid</option>
                    <option value="card">Card Payment</option>
                    <option value="upi">UPI Payment</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Step 7: GST Bill Upload -->
            <div class="mb-4">
              <div class="d-flex align-items-center mb-2">
                <span class="badge bg-primary me-2">7</span>
                <h5 class="mb-0 text-primary">GST Bill (Optional)</h5>
              </div>
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="gst_bill" class="form-label">Upload GST Bill/Invoice *</label>
                  <input type="file" class="form-control" id="gst_bill" name="gst_bill" accept=".pdf,.jpg,.jpeg,.png" required>
                  <div class="form-text">Upload GST bill or invoice (PDF, JPG, PNG) - Required for billing</div>
                </div>
              </div>
            </div>

            <!-- Step 8: Price Calculation -->
            <div class="mb-4">
              <div class="d-flex align-items-center mb-2">
                <span class="badge bg-primary me-2">8</span>
                <h5 class="mb-0 text-primary">Price Calculation</h5>
              </div>
              <div class="card bg-light mb-3">
                <div class="card-body">
                  <div class="row g-3">
                    <div class="col-6 col-md-3">
                      <strong>Base Rate:</strong>
                      <span id="baseRate">â‚¹0.00</span>
                    </div>
                    <div class="col-6 col-md-3">
                      <strong>Weight Charge:</strong>
                      <span id="weightCharge">â‚¹0.00</span>
                    </div>
                    <div class="col-6 col-md-3">
                      <strong>Subtotal:</strong>
                      <span id="subtotal">â‚¹0.00</span>
                    </div>
                    <div class="col-6 col-md-3">
                      <strong>Total Amount (incl. GST):</strong>
                      <span id="totalAmount" class="text-primary fw-bold">â‚¹0.00</span>
                    </div>
                  </div>
                  <div class="row g-3 mt-2">
                    <div class="col-12">
                      <strong>GST (18% of Subtotal):</strong>
                      <span id="gstAmountSeparate">â‚¹0.00</span>
                      <span id="gstAmount" style="display:none"></span>
                    </div>
                  </div>
                  <div class="row g-3 mt-2">
                    <div class="col-12">
                      <strong>Estimated Delivery:</strong>
                      <span id="estimatedDelivery">-</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Submit Button -->
            <div class="row mt-4">
              <div class="col-12 text-center">
                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" disabled>
                  <i class="fe-send me-2"></i>Place Order
                </button>
                <button type="button" class="btn btn-secondary btn-lg ms-2" onclick="calculatePrice()">
                  <i class="fe-calculator me-2"></i>Calculate Price
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentPincodeData = {};

// Pincode validation and auto-population
function validateAndPopulatePincode(pincode, type) {
    if (pincode.length !== 6 || !/^\d{6}$/.test(pincode)) {
        return;
    }

    fetch(`/api/pincode/${pincode}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.count > 0) {
                    // Always autofill with the top match
                    const pincodeData = data.data[0];
                    currentPincodeData[type] = pincodeData;
                    const districtInput = document.getElementById(`${type}_district`);
                    const stateInput = document.getElementById(`${type}_state`);
                    districtInput.value = pincodeData.district_name;
                    stateInput.value = pincodeData.state_name;
                    districtInput.dispatchEvent(new Event('input'));
                    stateInput.dispatchEvent(new Event('input'));
                }
            } else {
                showPincodeError(pincode, type);
                document.getElementById(`${type}_district`).value = '';
                document.getElementById(`${type}_state`).value = '';
            }
        })
        .catch(error => {
            console.error('Error validating pincode:', error);
            showPincodeError(pincode, type);
        });
}

// Replace showLocationOptions and modal logic with direct autofill
function handlePincodeResult(locations, type) {
  if (locations && locations.length > 0) {
    const best = locations[0];
    document.getElementById(type + '_district').value = best.district_name;
    document.getElementById(type + '_state').value = best.state_name;
    // Trigger input/change events for validation
    document.getElementById(type + '_district').dispatchEvent(new Event('input'));
    document.getElementById(type + '_state').dispatchEvent(new Event('input'));
  }
}

// Add event listeners for pincode validation
document.getElementById('pickup_pincode').addEventListener('blur', function() {
    validateAndPopulatePincode(this.value, 'pickup');
});

document.getElementById('delivery_pincode').addEventListener('blur', function() {
    validateAndPopulatePincode(this.value, 'delivery');
});

// Price calculation
function calculatePrice() {
    console.log('calculatePrice called');
    const weight = parseFloat(document.getElementById('weight').value) || 0;
    const quantity = parseInt(document.getElementById('quantity').value) || 1;
    const zoneSelect = document.getElementById('zone_id');
    const selectedOption = zoneSelect.options[zoneSelect.selectedIndex];
    console.log('weight:', weight, 'quantity:', quantity, 'zone:', selectedOption.value);
    if (!selectedOption.value) {
        console.log('No zone selected');
        alert('Please select a delivery zone first.');
        return;
    }
    if (weight <= 0) {
        console.log('Invalid weight');
        alert('Please enter a valid weight.');
        return;
    }
    const baseRate = parseFloat(selectedOption.dataset.rate) || 0;
    const weightCharge = baseRate * weight * quantity;
    const subtotal = weightCharge;
    const gstAmount = subtotal * 0.18;
    const totalAmount = subtotal + gstAmount;
    console.log('baseRate:', baseRate, 'weightCharge:', weightCharge, 'subtotal:', subtotal, 'gstAmount:', gstAmount, 'totalAmount:', totalAmount);
    document.getElementById('baseRate').textContent = `â‚¹${baseRate.toFixed(2)}`;
    document.getElementById('weightCharge').textContent = `â‚¹${weightCharge.toFixed(2)}`;
    document.getElementById('subtotal').textContent = `â‚¹${subtotal.toFixed(2)}`;
    document.getElementById('gstAmount').textContent = `â‚¹${gstAmount.toFixed(2)}`;
    document.getElementById('gstAmountSeparate').textContent = `â‚¹${gstAmount.toFixed(2)}`;
    document.getElementById('totalAmount').textContent = `â‚¹${totalAmount.toFixed(2)}`;
    // Calculate estimated delivery
    const deliveryDays = parseInt(selectedOption.dataset.days) || 0;
    const today = new Date();
    const estimatedDate = new Date(today.getTime() + (deliveryDays * 24 * 60 * 60 * 1000));
    document.getElementById('estimatedDelivery').textContent = estimatedDate.toLocaleDateString();
    console.log('Estimated delivery:', estimatedDate.toLocaleDateString());
}

// Form validation
function checkFormValidity() {
    const requiredFields = [
        'customer_name', 'customer_email', 'customer_phone',
        'pickup_address_line', 'pickup_pincode', 'pickup_district', 'pickup_state',
        'delivery_address_line', 'delivery_pincode', 'delivery_district', 'delivery_state',
        'package_type', 'zone_id', 'weight', 'length', 'width', 'height',
        'recipient_name', 'recipient_phone', 'payment_mode', 'gst_bill'
    ];
    
    let isValid = true;
    
    requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (!field.value.trim()) {
            isValid = false;
        }
    });
    
    // Check if both pincodes are valid
    if (!currentPincodeData.pickup || !currentPincodeData.delivery) {
        isValid = false;
    }
    
    document.getElementById('submitBtn').disabled = !isValid;
}

// Add event listeners for form validation
document.addEventListener('DOMContentLoaded', function() {
    const formFields = document.querySelectorAll('#placeOrderForm input, #placeOrderForm select, #placeOrderForm textarea');
    formFields.forEach(field => {
        field.addEventListener('input', checkFormValidity);
        field.addEventListener('change', checkFormValidity);
    });
    
    // Initial validation check
    checkFormValidity();
});

// Form submission
document.getElementById('placeOrderForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!currentPincodeData.pickup || !currentPincodeData.delivery) {
        alert('Please enter valid pincodes for both pickup and delivery addresses.');
        return;
    }
    
    // Show loading state
    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fe-loader me-2"></i>Processing...';
    submitBtn.disabled = true;
    
    // Submit form
    this.submit();
});

// Zone change event
document.getElementById('zone_id').addEventListener('change', function() {
    calculatePrice();
});
document.getElementById('weight').addEventListener('input', function() {
    calculatePrice();
});
document.getElementById('quantity').addEventListener('input', function() {
    calculatePrice();
});

const phoneInput = document.getElementById('customer_phone');
const phoneError = document.getElementById('phoneError');
const fakeNumbers = [
  '1234567890', '9999999999', '8888888888', '0000000000', '9876543210'
];

phoneInput.addEventListener('input', function(e) {
  // Prevent non-numeric input
  this.value = this.value.replace(/[^0-9]/g, '');
  // Limit to 10 digits
  if (this.value.length > 10) this.value = this.value.slice(0, 10);
});

phoneInput.addEventListener('blur', function() {
  const value = this.value;
  let error = '';
  if (!/^[6-9][0-9]{9}$/.test(value)) {
    error = 'Please enter a valid 10-digit Indian mobile number starting with 6, 7, 8, or 9.';
  } else if (fakeNumbers.includes(value)) {
    error = 'This looks like a fake or test number. Please enter your real mobile number.';
  }
  if (error) {
    phoneError.textContent = error;
    phoneError.style.display = 'block';
    this.classList.add('is-invalid');
  } else {
    phoneError.textContent = '';
    phoneError.style.display = 'none';
    this.classList.remove('is-invalid');
  }
});
</script>
{% endblock %} 
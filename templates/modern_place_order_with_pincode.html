<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Place Your Order - GotoFast Logistics</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body { font-family: 'Inter', 'Poppins', sans-serif; }
    </style>
</head>
<body class="bg-white min-h-screen flex items-center justify-center">
  <div class="w-full max-w-2xl mx-auto my-8 p-0">
    <div class="bg-[#f9f9f9] rounded-xl shadow-md p-6 sm:p-10">
      <div class="mb-8 text-center">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Place Your Order</h1>
        <p class="text-gray-500 text-base">Fill in the details below to place your delivery order</p>
      </div>
      <form id="placeOrderForm" method="POST" enctype="multipart/form-data" class="space-y-8">
        <!-- Customer Information -->
        <div>
          <h2 class="text-xl font-semibold text-blue-700 mb-4">Customer Information</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label for="customer_name" class="block text-gray-700 font-medium mb-1">Full Name *</label>
              <input type="text" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" id="customer_name" name="customer_name" required>
            </div>
            <div>
              <label for="customer_email" class="block text-gray-700 font-medium mb-1">Email Address *</label>
              <input type="email" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" id="customer_email" name="customer_email" required>
            </div>
            <div class="sm:col-span-2">
              <label for="customer_phone" class="block text-gray-700 font-medium mb-1">Phone Number *</label>
              <input type="tel" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" id="customer_phone" name="customer_phone" required placeholder="Enter mobile number" maxlength="10" pattern="[6-9][0-9]{9}">
              <div id="phoneError" class="text-red-500 text-sm mt-1 hidden"></div>
            </div>
          </div>
        </div>
        <!-- Pickup Address -->
        <div>
          <h2 class="text-xl font-semibold text-blue-700 mb-4">Pickup Address</h2>
          <div class="grid grid-cols-1 gap-4">
            <div>
              <label for="pickup_address_line" class="block text-gray-700 font-medium mb-1">Address Line *</label>
              <textarea class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" id="pickup_address_line" name="pickup_address_line" rows="2" required></textarea>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
              <div>
                <label for="pickup_pincode" class="block text-gray-700 font-medium mb-1">Pincode *</label>
                <input type="text" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" id="pickup_pincode" name="pickup_pincode" maxlength="6" required>
                <div class="text-xs text-gray-400 mt-1">Enter 6-digit pincode (Currently Serviceable in Jaipur_Rajasthan)</div>
              </div>
              <div>
                <label for="pickup_district" class="block text-gray-700 font-medium mb-1">District *</label>
                <input type="text" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition bg-gray-100" id="pickup_district" name="pickup_district" required readonly>
              </div>
              <div>
                <label for="pickup_state" class="block text-gray-700 font-medium mb-1">State *</label>
                <input type="text" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition bg-gray-100" id="pickup_state" name="pickup_state" required readonly>
              </div>
            </div>
          </div>
        </div>
        <!-- Delivery Address -->
        <div>
          <h2 class="text-xl font-semibold text-blue-700 mb-4">Delivery Address</h2>
          <div class="grid grid-cols-1 gap-4">
            <div>
              <label for="delivery_address_line" class="block text-gray-700 font-medium mb-1">Address Line *</label>
              <textarea class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" id="delivery_address_line" name="delivery_address_line" rows="2" required></textarea>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
              <div>
                <label for="delivery_pincode" class="block text-gray-700 font-medium mb-1">Pincode *</label>
                <input type="text" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" id="delivery_pincode" name="delivery_pincode" maxlength="6" required>
                <div class="text-xs text-gray-400 mt-1">Enter 6-digit pincode</div>
              </div>
              <div>
                <label for="delivery_district" class="block text-gray-700 font-medium mb-1">District *</label>
                <input type="text" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition bg-gray-100" id="delivery_district" name="delivery_district" required readonly>
              </div>
              <div>
                <label for="delivery_state" class="block text-gray-700 font-medium mb-1">State *</label>
                <input type="text" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition bg-gray-100" id="delivery_state" name="delivery_state" required readonly>
              </div>
            </div>
          </div>
        </div>
        <!-- Package Details -->
        <div>
          <h2 class="text-xl font-semibold text-blue-700 mb-4">Package Details</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label for="package_type" class="block text-gray-700 font-medium mb-1">Package Type *</label>
              <select class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" id="package_type" name="package_type" required>
                <option value="">Select Package Type</option>
                <option value="electronics">Electronics</option>
                <option value="clothing">Clothing</option>
                <option value="home">Home & Garden</option>
                <option value="books">Books & Documents</option>
                <option value="food">Food & Beverages</option>
                <option value="fragile">Fragile Items</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div>
              <label for="zone_id" class="block text-gray-700 font-medium mb-1">Delivery Zone *</label>
              <select class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" id="zone_id" name="zone_id" required>
                <option value="">Select Zone</option>
                {% for zone in zones %}
                <option value="{{ zone.id }}" data-rate="{{ zone.base_rate }}" data-days="{{ zone.delivery_days }}">
                    {{ zone.name }} - â‚¹{{ zone.base_rate }}/kg ({{ zone.delivery_days }} days)
                </option>
                {% endfor %}
              </select>
            </div>
            <div class="sm:col-span-2">
              <label for="weight" class="block text-gray-700 font-medium mb-1">Weight (kg) *</label>
              <input type="number" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" id="weight" name="weight" step="0.1" min="0.1" required>
            </div>
            <div class="sm:col-span-2">
              <label for="length" class="block text-gray-700 font-medium mb-1">Length (cm) *</label>
              <input type="number" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" id="length" name="length" step="0.1" min="1" required>
            </div>
            <div class="sm:col-span-2">
              <label for="width" class="block text-gray-700 font-medium mb-1">Width (cm) *</label>
              <input type="number" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" id="width" name="width" step="0.1" min="1" required>
            </div>
            <div class="sm:col-span-2">
              <label for="height" class="block text-gray-700 font-medium mb-1">Height (cm) *</label>
              <input type="number" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" id="height" name="height" step="0.1" min="1" required>
            </div>
            <div class="sm:col-span-2">
              <label for="quantity" class="block text-gray-700 font-medium mb-1">Quantity</label>
              <input type="number" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" id="quantity" name="quantity" value="1" min="1" required>
            </div>
            <div class="sm:col-span-2">
              <label for="package_description" class="block text-gray-700 font-medium mb-1">Package Description</label>
              <textarea class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" id="package_description" name="package_description" rows="2" placeholder="Describe your package contents..."></textarea>
            </div>
          </div>
        </div>
        <!-- Recipient Information -->
        <div>
          <h2 class="text-xl font-semibold text-blue-700 mb-4">Recipient Information</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label for="recipient_name" class="block text-gray-700 font-medium mb-1">Recipient Name *</label>
              <input type="text" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" id="recipient_name" name="recipient_name" required>
            </div>
            <div>
              <label for="recipient_phone" class="block text-gray-700 font-medium mb-1">Recipient Phone *</label>
              <input type="tel" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" id="recipient_phone" name="recipient_phone" required>
            </div>
          </div>
        </div>
        <!-- Payment Information -->
        <div>
          <h2 class="text-xl font-semibold text-blue-700 mb-4">Payment Information</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label for="payment_mode" class="block text-gray-700 font-medium mb-1">Payment Mode *</label>
              <select class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" id="payment_mode" name="payment_mode" required>
                <option value="">Select Payment Mode</option>
                <option value="cod">Cash on Delivery (COD)</option>
                <option value="prepaid">Prepaid</option>
                <option value="card">Card Payment</option>
                <option value="upi">UPI Payment</option>
              </select>
            </div>
          </div>
        </div>
        <!-- GST Bill Upload -->
        <div>
          <h2 class="text-xl font-semibold text-blue-700 mb-4">GST Bill (Optional)</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label for="gst_bill" class="block text-gray-700 font-medium mb-1">Upload GST Bill/Invoice *</label>
              <input type="file" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" id="gst_bill" name="gst_bill" accept=".pdf,.jpg,.jpeg,.png" required>
              <div class="text-xs text-gray-400 mt-1">Upload GST bill or invoice (PDF, JPG, PNG) - Required for billing</div>
            </div>
          </div>
        </div>
        <!-- Price Calculation -->
        <div>
          <h2 class="text-xl font-semibold text-blue-700 mb-4">Price Calculation</h2>
          <div class="bg-gray-100 rounded-lg p-4">
            <div class="grid grid-cols-1 sm:grid-cols-4 gap-4">
              <div>
                <strong>Base Rate:</strong>
                <span id="baseRate" class="text-blue-700 font-semibold">â‚¹0.00</span>
              </div>
              <div>
                <strong>Weight Charge:</strong>
                <span id="weightCharge" class="text-blue-700 font-semibold">â‚¹0.00</span>
              </div>
              <div>
                <strong>GST (18%):</strong>
                <span id="gstAmount" class="text-blue-700 font-semibold">â‚¹0.00</span>
              </div>
              <div>
                <strong>Total Amount:</strong>
                <span id="totalAmount" class="text-blue-700 font-semibold">â‚¹0.00</span>
              </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
              <div>
                <strong>Estimated Delivery:</strong>
                <span id="estimatedDelivery" class="text-blue-700 font-semibold">-</span>
              </div>
            </div>
          </div>
        </div>
        <!-- Submit Button -->
        <div class="flex justify-end gap-4">
          <button type="button" id="calculatePriceBtn" class="border border-blue-600 text-blue-600 font-semibold rounded-lg px-8 py-3 transition hover:bg-blue-50">Calculate Price</button>
          <button type="submit" id="submitBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg px-8 py-3 transition">Book Order</button>
        </div>
      </form>
    </div>
  </div>
  <script>
    // Calculate Price button logic
    document.addEventListener('DOMContentLoaded', function() {
      const calcBtn = document.getElementById('calculatePriceBtn');
      if (calcBtn) {
        calcBtn.addEventListener('click', function(e) {
          if (typeof calculatePrice === 'function') {
            calculatePrice();
          }
        });
      }
    });

    // Pincode autofill and validation logic
    function fetchPincodeDetails(pincode, districtField, stateField) {
      if (pincode.length === 6 && /^\d{6}$/.test(pincode)) {
        fetch(`/api/pincode/${pincode}`)
          .then(response => response.json())
          .then(data => {
            if (data.success && data.data && data.data.length > 0) {
              const info = data.data[0];
              document.getElementById(districtField).value = info.district_name || '';
              document.getElementById(stateField).value = info.state_name || '';
            } else {
              document.getElementById(districtField).value = '';
              document.getElementById(stateField).value = '';
            }
          })
          .catch(() => {
            document.getElementById(districtField).value = '';
            document.getElementById(stateField).value = '';
          });
      } else {
        document.getElementById(districtField).value = '';
        document.getElementById(stateField).value = '';
      }
    }
    document.getElementById('pickup_pincode').addEventListener('input', function() {
      fetchPincodeDetails(this.value, 'pickup_district', 'pickup_state');
    });
    document.getElementById('delivery_pincode').addEventListener('input', function() {
      fetchPincodeDetails(this.value, 'delivery_district', 'delivery_state');
    });
    let currentPincodeData = {};
    function validateAndPopulatePincode(pincode, type) {
      if (pincode.length !== 6 || !/^\d{6}$/.test(pincode)) {
        return;
      }
      fetch(`/api/pincode/${pincode}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const pincodeData = data.data[0];
            currentPincodeData[type] = pincodeData;
            document.getElementById(`${type}_district`).value = pincodeData.district_name;
            document.getElementById(`${type}_state`).value = pincodeData.state_name;
            checkFormValidity();
          } else {
            document.getElementById(`${type}_district`).value = '';
            document.getElementById(`${type}_state`).value = '';
          }
        })
        .catch(() => {
          document.getElementById(`${type}_district`).value = '';
          document.getElementById(`${type}_state`).value = '';
        });
    }
    document.getElementById('pickup_pincode').addEventListener('blur', function() {
      validateAndPopulatePincode(this.value, 'pickup');
    });
    document.getElementById('delivery_pincode').addEventListener('blur', function() {
      validateAndPopulatePincode(this.value, 'delivery');
    });
    function checkFormValidity() {
      const requiredFields = [
        'customer_name', 'customer_email', 'customer_phone',
        'pickup_address_line', 'pickup_pincode', 'pickup_district', 'pickup_state',
        'delivery_address_line', 'delivery_pincode', 'delivery_district', 'delivery_state',
        'package_type', 'zone_id', 'weight', 'length', 'width', 'height',
        'recipient_name', 'recipient_phone', 'payment_mode', 'gst_bill'
      ];
      let isValid = true;
      requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (!field.value.trim()) {
          isValid = false;
        }
      });
      if (!currentPincodeData.pickup || !currentPincodeData.delivery) {
        isValid = false;
      }
      document.getElementById('submitBtn').disabled = !isValid;
    }
    document.addEventListener('DOMContentLoaded', function() {
      const formFields = document.querySelectorAll('#placeOrderForm input, #placeOrderForm select, #placeOrderForm textarea');
      formFields.forEach(field => {
        field.addEventListener('input', checkFormValidity);
        field.addEventListener('change', checkFormValidity);
      });
      checkFormValidity();
    });
  </script>
</body>
</html>
{# All booking/order logic and form fields are preserved as in the original template. #}

{% block scripts %}
<script>
function calculatePrice() {
    const weight = parseFloat(document.getElementById('weight').value) || 0;
    const zoneSelect = document.getElementById('zone_id');
    const selectedOption = zoneSelect.options[zoneSelect.selectedIndex];
    
    if (!selectedOption.value) {
        alert('Please select a delivery zone first.');
        return;
    }
    
    const baseRate = parseFloat(selectedOption.dataset.rate) || 0;
    const weightCharge = baseRate * weight;
    const gstAmount = weightCharge * 0.18;
    const totalAmount = weightCharge + gstAmount;
    
    // Update display
    document.getElementById('baseRate').textContent = `â‚¹${baseRate.toFixed(2)}`;
    document.getElementById('weightCharge').textContent = `â‚¹${weightCharge.toFixed(2)}`;
    document.getElementById('gstAmount').textContent = `â‚¹${gstAmount.toFixed(2)}`;
    document.getElementById('totalAmount').textContent = `â‚¹${totalAmount.toFixed(2)}`;
    
    // Calculate estimated delivery
    const deliveryDays = parseInt(selectedOption.dataset.days) || 0;
    const today = new Date();
    const estimatedDate = new Date(today.getTime() + (deliveryDays * 24 * 60 * 60 * 1000));
    document.getElementById('estimatedDelivery').textContent = estimatedDate.toLocaleDateString();
}

// Form submission
document.getElementById('placeOrderForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!currentPincodeData.pickup || !currentPincodeData.delivery) {
        alert('Please enter valid pincodes for both pickup and delivery addresses.');
        return;
    }
    
    // Show loading state
    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fe-loader me-2"></i>Processing...';
    submitBtn.disabled = true;
    
    // Submit form
    this.submit();
});

// Zone change event
document.getElementById('zone_id').addEventListener('change', function() {
    calculatePrice();
});

const phoneInput = document.getElementById('customer_phone');
const phoneError = document.getElementById('phoneError');
const fakeNumbers = [
  '1234567890', '9999999999', '8888888888', '0000000000', '9876543210'
];

phoneInput.addEventListener('input', function(e) {
  // Prevent non-numeric input
  this.value = this.value.replace(/[^0-9]/g, '');
  // Limit to 10 digits
  if (this.value.length > 10) this.value = this.value.slice(0, 10);
});

phoneInput.addEventListener('blur', function() {
  const value = this.value;
  let error = '';
  if (!/^[6-9][0-9]{9}$/.test(value)) {
    error = 'Please enter a valid 10-digit Indian mobile number starting with 6, 7, 8, or 9.';
  } else if (fakeNumbers.includes(value)) {
    error = 'This looks like a fake or test number. Please enter your real mobile number.';
  }
  if (error) {
    phoneError.textContent = error;
    phoneError.style.display = 'block';
    this.classList.add('is-invalid');
  } else {
    phoneError.textContent = '';
    phoneError.style.display = 'none';
    this.classList.remove('is-invalid');
  }
});
</script>
{% endblock %} 